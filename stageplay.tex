\startenvironment stageplay

\mainlanguage[en]

\setuplayout[
	top=0.5in,
	topdistance=\zeropoint,
	header=0.5in,
	margindistance=\zeropoint,
	leftedge=0.5in,
	leftmargin=1in,
	rightmargin=1in,
	width=fit,
	footer=0.5in,
	bottom=0.5in,
	bottomdistance=\zeropoint,
	height=fit,
	topspace=\dimexpr \topheight + \topdistance\relax,
	backspace=\dimexpr \leftedgewidth + \leftmarginwidth\relax
]

\definelayout[coverpage][
	top=4in,
	header=\zeropoint,
	footer=3in,
	bottom=1in
]

\definelayout[lastpage][
	footer=2\lineheight,
	bottom=1in
]

\starttypescript[courier10pitch]
	\definefontsynonym[Courier10PitchBT-Roman][file:Courier10PitchBT-Roman]
	\definefontsynonym[Courier10PitchBT-Italic][file:Courier10PitchBT-Italic]
	\definefontsynonym[Courier10PitchBT-Bold][file:Courier10PitchBT-Bold]
	\definefontsynonym[Courier10PitchBT-BoldItalic][file:Courier10PitchBT-BoldItalic]
\stoptypescript

\starttypescript[courier10pitch]
	\setup[font:fallback:serif]
	\definefontsynonym[SerifRegular][Serif]
	\definefontsynonym[Serif][Courier10PitchBT-Roman][features=default]
	\definefontsynonym[SerifItalic][Courier10PitchBT-Italic][features=default]
	\definefontsynonym[SerifBold][Courier10PitchBT-Bold][features=default]
	\definefontsynonym[SerifBoldItalic][Courier10PitchBT-BoldItalic][features=default]
\stoptypescript

\starttypescript[courier10pitch]
	\definetypeface[courier10pitch][rm][serif][courier10pitch][default]
\stoptypescript

\setupbodyfont[courier10pitch, 12pt]
\setuppapersize[letter][letter]
\setupalign[nothyphenated, flushleft]
\setuppagenumbering[location={header, right}, right={.}]
\setuppagenumber[state=stop]
\setupblank[big]
\setupinterlinespace[small]
\setupwhitespace[none]
\setuptolerance[strict]

\definemeasure[dialogoffset][\zeropoint]
\definemeasure[headeroffset][2in]
\definemeasure[subjectoffset][\measure{headeroffset}]
\definemeasure[speakeroffset][\measure{headeroffset}]
\definemeasure[openoffset][\measure{headeroffset}]
\definemeasure[parentheticaloffset][1.5in]
\definemeasure[stageoffset][\measure{parentheticaloffset}]
\definemeasure[simultaneousdelta][0.5\measured{speakeroffset}]

\setuplabeltext[
	chapter={Act~},
	section={Scene~},
	prologue={Prologue},
	epilogue={Epilogue},
	continued={Cont'd},
	more={More},
	cast={Cast of Characters},
	theend={End.},
	by={By},
	time={Time},
	setting={Setting},
	synopsis={Synopsis}
]

\definemode[final][keep]
\definemode[dialogblock][no]
\definemode[simultaneousblock][no]

\startsetups[doc:bodypart:before]
	\setuppagenumber[state=start]
	\setupheader[state=empty]
\stopsetups

\startsetups[doc:bodypart:after]
	\setupfootertexts[
		\hskip \measure{headeroffset}
		\WORD \labeltext{theend}
	][]
\stopsetups

\setupsectionblock[bodypart][page=yes, before={\setup[doc:bodypart:before]}]

\def\startplaymatter{\startbodymatter}

\def\stopplaymatter{%
	\setup[doc:bodypart:after]%
	\stopbodymatter
}

\unprotect

\setuphead[title][
	page=yes,
	textstyle=cap,
	style={\tf},
	align=middle,
	textcommand=\firstofoneargument,
	before={\blank},
	after={\blank}
]

\definehead[covertitle][title]

\setuphead[covertitle][
	style={\tf\bf},
	before={},
	after={}
]

\definehead[coversubtitle][covertitle]
\setuphead[coversubtitle][page=no, style={\tf}]

\definehead[author][subsubject]

\setuphead[author][
	page=no,
	style={\tf},
	align=middle,
	interlinespace=0pt,
	before={},
	after={\blank}
]

\setuphead[subject][
	page=no,
	textstyle=cap,
	style={\tf},
	align=flushleft,
	interlinespace=0pt,
	textcommand={\advance\leftskip\measure{subjectoffset}\firstofoneargument},
	before={\blank},
	after={\blank}
]

\def\@dosettingtext#1{\labeltext{setting}\doiftext{#1}{:~#1}}
\definehead[setting][subject]
\setuphead[setting][textcommand=\@dosettingtext]

\def\@dosettingtimetext#1{\labeltext{time}\doiftext{#1}{:~#1}}
\definehead[settingtime][subject]
\setuphead[settingtime][textcommand=\@dosettingtimetext]

\definehead[synopsis][subject]
\setuphead[synopsis][textcommand={\labeltext{synopsis}\gobbleoneargument}]

\setuphead[chapter][
	page=no,
	conversion=I,
	style={\tf\WORD},
	interlinespace=0pt,
	textcommand={\advance\leftskip\measure{headeroffset}\firstofoneargument},
	before={\testpage[3]},
	after={\blank}
]

\definehead[act][chapter]

\def\@doprologuetext#1{%
	\advance\leftskip\measure{headeroffset}%
	\labeltext{prologue}\doiftext{#1}{:~#1}%
}

\definehead[prologue][chapter]

\setuphead[prologue][
	number=no,
	incrementnumber=no,
	textcommand=\@doprologuetext
]

\def\@doepiloguetext#1{%
	\advance\leftskip\measure{headeroffset}%
	\labeltext{epilogue}\doiftext{#1}{:~#1}%
}

\definehead[epilogue][chapter]

\setuphead[epilogue][
	number=no,
	incrementnumber=no,
	textcommand=\@doepiloguetext
]

\startsetups[doc:scenenumber]
	\labeltext{section}
	\determineheadnumber[chapter]
	\convertnumber{I}{\currentheadnumber}
	-
	\determineheadnumber[section]
	\currentheadnumber
\stopsetups

\definehead[scene][section]

\setuphead[scene][
	page=no,
	style={\tf\WORD},
	interlinespace=0pt,
	textcommand={\advance\leftskip\measure{headeroffset}\firstofoneargument},
	numbercommand={\setup[doc:scenenumber]\gobbleoneargument},
	before={\testpage[3]},
	after={\blank}
]

\def\@speakeroffset{%
	\doifmodeelse{simultaneousblock}{%
		\dimexpr\measured{speakeroffset} - \measured{simultaneousdelta}\relax
	}{\measure{speakeroffset}}%
}

\definehead[speaker][subject]

\setuphead[speaker][
	style={\tf},
	interlinespace=0pt,
	textcommand={\advance\leftskip\@speakeroffset\firstofoneargument},
	before={\testpage[3]},
	after={\page[none]}
]

\setupcombinedlist[content][list={act, scene}, alternative=c]
\definelist[cast][criterium=local, alternative=f, interaction=none]

\setupinteraction[state=start, color=middleblue]
\placebookmarks[act, scene]

\defineparagraphs[casting][
	n=2,
	distance=\zeropoint,
	before={},
	after={\blank}
]

\setupparagraphs[casting][1][width={0.25\textwidth}]
\setupparagraphs[casting][2][width={0.75\textwidth}]

\startsetups[doc:simultaneous:inner]
	\enablemode[simultaneousblock]
	\setupinterlinespace[reset]
	\setupblank[big]
	\setupwhitespace[none]
\stopsetups

\defineparagraphs[simultaneous][
	n=2,
	align=flushleft,
	distance=\bodyfontsize,
	inner={\setup[doc:simultaneous:inner]},
	before={\vbox\bgroup\vskip\dimexpr\strutdepthfactor\lineheight\relax},
	after={\egroup\blank}
]

\def\@simultaneouswidth{\glueexpr 0.5\textwidth - 0.5\bodyfontsize\relax}
\setupparagraphs[simultaneous][1][width={\@simultaneouswidth}]
\setupparagraphs[simultaneous][2][width={\@simultaneouswidth}]

\startsetups[coverpage:footer]
	\let\\\blank
	\rlap{\getvalue{stageplay:copyright}\unskip}
	\vbox{
		\startalignment[flushright]
		\setupblank[packed]
		\getvalue{stageplay:contact}\unskip
		\stopalignment
	}
\stopsetups

\startsetups[coverpage]
	\let\\\blank
	\setuplayout[coverpage]
	\doiftext{\getvalue{stageplay:title}}{
		\covertitle{\getvalue{stageplay:title}}
	}
	\doiftext{\getvalue{stageplay:subtitle}}{
		\coversubtitle{\getvalue{stageplay:subtitle}}
	}
	\doiftext{\getvalue{stageplay:author}}{
		\blank[2*line]
		\author{\labeltext{by}~\getvalue{stageplay:author}}
	}
	\setupfootertexts[{\setup[coverpage:footer]}][][][]
	\break
	\setuplayout[reset]
\stopsetups

\def\makecoverpage{\setup[coverpage]}

\def\makecastsection{
	\subject{\labeltext{cast}}
	\blank[2*line]
	\placelist[cast]
	\blank[2*line]
}

\def\@startrelaxpar{\let\@oldpar\par\let\par\relax}
\def\@stoprelaxpar{\let\par\@oldpar}

\def\dostartblock[#1]{%
	\begingroup
	\getparameters[local][before=\relax, after=\relax, style=\relax, #1]%
	\endgraf
	\@startrelaxpar
	\vtop\bgroup
	\localbefore
	\localstyle
}

\def\startblock{\dosingleempty\dostartblock}

\def\stopblock{\localafter\egroup\@stoprelaxpar\endgroup}

\definestartstop[open][before={\setup[open:before]}, after={\setup[open:after]}]

\def\open#1{\startopen#1\stopopen}

\startsetups[open:italicize:before]
	\startblock[style={\emph}, before={\advance\leftskip\measure{openoffset}}]
\stopsetups

\startsetups[open:italicize:after]
	\stopblock
	\blank
\stopsetups

\startsetups[doc:open:italicize]
	\setupstartstop[open][
		before={\setup[open:italicize:before]},
		after={\setup[open:italicize:after]}
	]
\stopsetups

\startsetups[open:uppercase:before]
	\startblock[style={\WORD}]
	\@startrelaxpar
\stopsetups

\startsetups[open:uppercase:after]
	\@stoprelaxpar
	\stopblock
	\blank
\stopsetups

\startsetups[doc:open:uppercase]
	\setupstartstop[open][
		before={\setup[open:uppercase:before]},
		after={\setup[open:uppercase:after]}
	]
\stopsetups

\startsetups[open:before]
	\startblock[before={\advance\leftskip\measure{openoffset}}]
	(
\stopsetups

\startsetups[open:after]
	\unskip
	)
	\stopblock
	\blank
\stopsetups

\definestartstop[stage][before={\setup[stage:before]}, after={\setup[stage:after]}]

\def\stage#1{\startstage#1\stopstage}

\startsetups[doc:stage:italicize]
	\definemeasure[stageoffset][\measure{openoffset}]
	\setupstartstop[stage][
		before={\setup[stage:italicize:before]},
		after={\setup[stage:italicize:after]}
	]
\stopsetups

\startsetups[stage:before]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:before]}
		{\setup[stage:framed:before]}
\stopsetups

\startsetups[stage:after]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:after]}
		{\setup[stage:framed:after]}
\stopsetups

\startsetups[stage:italicize:framed:before]
	\startblock[style={\emph}, before={\advance\leftskip\measure{stageoffset}}]
\stopsetups

\startsetups[stage:italicize:framed:after]
	\stopblock
	\blank
\stopsetups

\startsetups[stage:italicize:before]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:before]}
		{\setup[stage:italicize:framed:before]}
\stopsetups

\startsetups[stage:italicize:after]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:after]}
		{\setup[stage:italicize:framed:after]}
\stopsetups

\startsetups[stage:framed:before]
	\startblock[before={\advance\leftskip\measure{stageoffset}}]
	(
\stopsetups

\startsetups[stage:framed:after]
	\unskip
	)
	\stopblock
	\blank
\stopsetups

\startsetups[stage:dialog:before]
	\testpage[2]
	\startnarrow[
		left={
			\doifmodeelse{simultaneousblock}
				{\dimexpr\measured{parentheticaloffset} - \measured{simultaneousdelta}\relax}
				{\measure{parentheticaloffset}}
		}
	][left]
	(
\stopsetups

\startsetups[stage:dialog:after]
	\unskip
	)
	\stopnarrow
\stopsetups

\newconditional\@speakeractive
\let\@lastsplitspeaker\empty

\def\@dospeakercontinue{%
	\speaker{\settightstrut\@lastsplitspeaker~(\labeltext{continued})}%
}

\appendtoks
	\ifconditional\@speakeractive
		\global\let\@lastsplitspeaker\dialogspeaker
	\fi
\to \everyendoftextbody

\appendtoks
	\ifx\@lastsplitspeaker\empty\else
		% \@dospeakercontinue
	\fi
	\global\let\@lastsplitspeaker\empty
\to \everyaftershipout

\def\startdialog#1[#2]{%
	\enablemode[dialogblock]%
	\getparameters[dialog][speaker=, continued=no, #2]%
	\begingroup
	\speaker{\dialogspeaker}%
	\@startrelaxpar
	\vtop\bgroup
	\global\settrue\@speakeractive
}

\def\stopdialog{%
	\global\setfalse\@speakeractive
	\egroup
	\@stoprelaxpar
	\endgroup
	\disablemode[dialogblock]%
	\blank
}

\def\dialog#1#2{\startdialog[speaker={#1}]#2\stopdialog}

\def\@docharacter#1#2{%
	\doiftextelse{#2}%
		{\dialog{#1}{#2}}%
		{\doifmodeelse{dialogblock}{#1}{{\WORD #1}}\autoinsertnextspace}%
}

\def\@registercharacter#1{%
	\doflushatpar{%
		\dontleavehmode\writetolist[cast]{}{%
			\startcasting
			{\WORD \csname#1name\endcsname}%
			\casting
			\doifdefined{#1pronouns}{(\csname#1pronouns\endcsname)}%
			\doifdefined{#1description}{\space\csname#1description\endcsname}%
			\stopcasting
		}%
	}%
}

\def\@fakecapitalize#1#2{{\WORD #1}#2}

\def\definecharacter#1[#2][#3]{%
	\getparameters[#2][name={\@fakecapitalize#2}, #3]%
	\@registercharacter{#2}%
	\expandafter\def\csname#2\endcsname{%
		\dodoublegroupempty\@docharacter{\csname#2name\endcsname}%
	}%
	\expandafter\def\csname start#2\endcsname{%
		\startdialog[speaker={\csname#2name\endcsname}]%
	}%
	\expandafter\def\csname stop#2\endcsname{\stopdialog}%
}

\def\draft#1{\doifmodeelse{final}{\ignorespaces}{\color[middlered]{#1}}}

\def\@dosetupstageplay[#1]{%
	\getparameters[stageplay:]%
		[stage=, open=, title=, subtitle=, copyright=, contact=, #1]%
	\processaction[\getvalue{stageplay:stage}][
		italicize=>{\setup[doc:stage:italicize]},
		default=>\relax,
		unknown=>\unknown{\commalistelement}
	]%
	\processaction[\getvalue{stageplay:open}][
		italicize=>{\setup[doc:open:italicize]},
		uppercase=>{\setup[doc:open:uppercase]},
		default=>\relax,
		unknown=>\unknown{\commalistelement}
	]%
}

\def\setupstageplay{\dosingleempty\@dosetupstageplay}

\protect

\stopenvironment
