\startenvironment stageplay

\mainlanguage[en]

\setupbodyfont[tt, 12pt]
\setuppapersize[letter][letter]
\setupalign[nothyphenated, flushleft]
\setuppagenumbering[location={header, right}, right={.}]
\setuppagenumber[state=stop]
\setupsectionblock[bodypart][page=yes, before={\setuppagenumber[state=start]}]
\setupblank[big]
\setuptolerance[horizontal, strict]

\setuplayout[
	backspace=1.5in,
	width=6in,
	topspace=0.5in,
	header=0.5in,
	height=10in,
	footer=0in
]

\setuplabeltext[
	chapter={Act~},
	section={Scene~},
	continued={Cont'd},
	more={More},
	cast={Cast of Characters},
	theend={The End},
	by={By}
]

\definemode[final][keep]
\definemode[dialogblock][no]
\definemode[simultaneousblock][no]

\unprotect

\setuphead[title][
	page=yes,
	style={\tf\sc},
	align=middle,
	after={\blank}
]

\definehead[covertitle][title]

\setuphead[covertitle][
	page=no,
	textstyle=cap,
	style={\tf\bf},
	before={},
	after={}
]

\definehead[coversubtitle][title]
\setuphead[coversubtitle][page=no, before={}, after={}]

\definehead[author][subsubject]

\setuphead[author][
	page=no,
	style={\tf},
	align=middle,
	before={},
	after={\blank}
]

\setuphead[subject][
	page=no,
	style={\tf\sc},
	align=middle,
	after={\blank}
]

\definehead[act][chapter]

\setuphead[act][
	page=no,
	conversion=I,
	style={\tf\sc},
	before={\blank\testpage[3]\hskip 2.5in},
	after={\blank}
]

\startsetups[doc:scenenumber]
	\labeltext{section}
	\determineheadnumber[chapter]
	\convertnumber{I}{\currentheadnumber}
	-
	\determineheadnumber[section]
	\currentheadnumber
\stopsetups

\definehead[scene][section]

\setuphead[scene][
	page=no,
	style={\tf\sc},
	numbercommand={\setup[doc:scenenumber]\gobbleoneargument},
	before={\blank\testpage[3]\hskip 2.5in},
	after={\blank}
]

\definehead[speaker][subsubject]

\setuphead[speaker][
	page=no,
	style={\tf},
	textstyle=cap,
	before={\doifmodeelse{simultaneousblock}{\hskip 1.5in}{\hskip 2.5in}},
	after={}
]

\definehead[theend][subsubsubject]

\setuphead[theend][
	page=no,
	style={\tf\sc},
	textcommand={\labeltext{theend}},
	before={\vfill\hskip 2.5in},
	after={}
]

\setupcombinedlist[content][list={act, scene}, alternative=c]

\setupinteraction[state=start, color=middleblue]
\placebookmarks[act, scene]

\defineparagraphs[casting][n=2, before={}, after={\blank}]
\setupparagraphs[casting][1][width={0.25\textwidth}]
\setupparagraphs[casting][2][width={0.75\textwidth}]

\defineparagraphs[simultaneous][
	n=2,
	distance={1em},
	inner={\enablemode[simultaneousblock]},
	after={\blank}
]

\setupparagraphs[simultaneous][1][width={\glueexpr 0.5\textwidth - 0.5em\relax}]
\setupparagraphs[simultaneous][2][width={\glueexpr 0.5\textwidth - 0.5em\relax}]

\definestartstop[coverpage][before={\vbox\bgroup\godown[3in]}, after={\egroup\break}]

\define[0]\makecoverpage{
	\startcoverpage
	\doiftext{\getvariable{metadata}{title}}{
		\covertitle{\getvariable{metadata}{title}}
	}

	\doiftext{\getvariable{metadata}{subtitle}}{
		\coversubtitle{\getvariable{metadata}{subtitle}}
	}

	\doiftext{\getvariable{metadata}{author}}{
		\blank[2*line]
		\author{\labeltext{by}\getvariable{metadata}{author}}
	}
	\stopcoverpage
}

\define[0]\makecastsection{
	\subject{\labeltext{cast}}
	\blank[2*line]
	\placelist[characters]
}

\definestartstop[block][
	before={\let\@blockpar\par\let\par\relax},
	after={\let\par\@blockpar}
]

\startsetups[open:before]
	\startframedtext[
		frame=off,
		offset=none,
		loffset=2.5in,
		width=broad,
		align=flushleft,
		before={},
		after={}
	]
	\startblock
	(
\stopsetups

\startsetups[open:after]
	\unskip
	)
	\stopblock
	\stopframedtext
	\blank
\stopsetups

\definestartstop[open][before={\setup[open:before]}, after={\setup[open:after]}]

\define[1]\open{\startopen#1\stopopen}

\startsetups[stage:framed:before]
	\startframedtext[
		frame=off,
		offset=none,
		loffset=2in,
		width=broad,
		align=flushleft,
		before={},
		after={}
	]
	\startblock
	(
\stopsetups

\startsetups[stage:framed:after]
	\unskip
	)
	\stopblock
	\stopframedtext
	\blank
\stopsetups

\startsetups[stage:dialog:before]
	\startnarrow[left={\doifmodeelse{simultaneousblock}{1in}{2in}}][left]
	\startblock
	(
\stopsetups

\startsetups[stage:dialog:after]
	\unskip
	)
	\stopblock
	\stopnarrow
\stopsetups

\startsetups[stage:before]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:before]}
		{\setup[stage:framed:before]}
\stopsetups

\startsetups[stage:after]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:after]}
		{\setup[stage:framed:after]}
\stopsetups

\definestartstop[stage][before={\setup[stage:before]}, after={\setup[stage:after]}]

\define[1]\stage{\startstage#1\stopstage}

\def\startdialog#1[#2]{%
	\begingroup
	\getparameters[xx][#2]
	\doifdefined{xxsubject}{%
		\testpage[2]
		\speaker{
			\xxsubject
			\doifdefined{xxcontinued}{\doif{\xxcontinued}{yes}{~(\labeltext{continued})}}
		}
	}
	\endgroup
	\startframedtext[
		frame=off,
		offset=none,
		width=broad,
		align=flushleft,
		inner={\enablemode[dialogblock]},
		before={},
		after={\blank}
	]
}

\define[0]\stopdialog{\stopframedtext}

\define[2]\dialog{\startdialog[subject={#1}]#2\stopdialog}

\definelist[characters][criterium=local, alternative=f, interaction=none]

\def\@docharacter[#1]#2{\doiftextelse{#2}{\dialog{#1}{#2}}{{\WORD #1}}}

\def\@registercharacter#1{%
	\doflushatpar{%
		\dontleavehmode\writetolist[characters]{}{%
			\startcasting
			{\WORD \csname#1name\endcsname}
			\casting
			\doifdefined{#1pronouns}{(\csname#1pronouns\endcsname)}
			\doifdefined{#1description}{\csname#1description\endcsname}
			\stopcasting
		}%
	}%
}

\def\setupcharacter#1[#2][#3]{%
	\getparameters[#2][name=#2, #3]
	\@registercharacter{#2}
	\expandafter\def\csname#2\endcsname##1{\@docharacter[\csname#2name\endcsname]{##1}}
	\expandafter\def\csname start#2\endcsname{\startdialog[subject={\csname#2name\endcsname}]}
	\expandafter\def\csname stop#2\endcsname{\stopdialog}
}

\define[1]\draft{\doifmodeelse{final}{\ignorespaces}{\color[middlered]{#1}}}

\startsetups[stage:italicize:framed:before]
	\startframedtext[
		frame=off,
		style={\emph},
		offset=none,
		loffset=2.5in,
		width=broad,
		align=flushleft,
		before={},
		after={}
	]
	\startblock
\stopsetups

\startsetups[stage:italicize:framed:after]
	\stopblock
	\stopframedtext
	\blank
\stopsetups

\startsetups[stage:italicize:before]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:before]}
		{\setup[stage:italicize:framed:before]}
\stopsetups

\startsetups[stage:italicize:after]
	\doifmodeelse{dialogblock}
		{\setup[stage:dialog:after]}
		{\setup[stage:italicize:framed:after]}
\stopsetups

\startsetups[doc:stage:italicize]
	\setupstartstop[stage][
		before={\setup[stage:italicize:before]},
		after={\setup[stage:italicize:after]}
	]
\stopsetups

\def\setupstageplay#1[#2]{
	\getparameters[stageplay:][stage=, #2]

	\processaction[\getvalue{stageplay:stage}][
		italicize=>{\setup[doc:stage:italicize]},
		default=>\relax,
		unknown=>\unknown{\commalistelement}
	]
}

\protect

\stopenvironment
